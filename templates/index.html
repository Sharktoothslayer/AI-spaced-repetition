<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Language Learning Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px 0;
            box-shadow: 2px 0 20px rgba(0,0,0,0.1);
        }

        .sidebar-header h2 {
            text-align: center;
            color: #333;
            margin: 0 0 30px 0;
            font-size: 1.3rem;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 0 20px;
        }

        .nav-button {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-radius: 12px;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            width: 100%;
        }

        .nav-button:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .nav-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .nav-icon {
            font-size: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tab-content {
            display: none;
            width: 100%;
            max-width: 900px;
        }

        .tab-content.active {
            display: block;
        }

        /* Chat Container */
        .chat-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

                 .chat-header {
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
             color: white;
             padding: 20px;
             text-align: center;
             border-bottom: 1px solid rgba(255, 255, 255, 0.1);
         }

                 .chat-header h1 {
             font-size: 1.5rem;
             font-weight: 600;
             margin-bottom: 10px;
         }

         .chat-controls {
             display: flex;
             justify-content: space-between;
             align-items: center;
             flex-wrap: wrap;
             gap: 15px;
         }

         .vocabulary-toggle {
             display: flex;
             align-items: center;
             gap: 15px;
             background: rgba(255, 255, 255, 0.1);
             padding: 12px 20px;
             border-radius: 25px;
             min-width: 200px;
         }

         .toggle-label {
             display: flex;
             align-items: center;
             gap: 10px;
             font-size: 14px;
             font-weight: 500;
             color: white;
             cursor: pointer;
         }

         /* Toggle Switch Styles */
         .toggle-switch {
             position: relative;
             display: inline-block;
             width: 50px;
             height: 24px;
             flex-shrink: 0;
         }

         .toggle-switch input {
             opacity: 0;
             width: 0;
             height: 0;
         }

         .toggle-slider {
             position: absolute;
             cursor: pointer;
             top: 0;
             left: 0;
             right: 0;
             bottom: 0;
             background-color: rgba(255, 255, 255, 0.3);
             transition: 0.3s;
             border-radius: 24px;
         }

         .toggle-slider:before {
             position: absolute;
             content: "";
             height: 18px;
             width: 18px;
             left: 3px;
             bottom: 3px;
             background-color: white;
             transition: 0.3s;
             border-radius: 50%;
         }

         .toggle-switch input:checked + .toggle-slider {
             background-color: #28a745;
         }

         .toggle-switch input:checked + .toggle-slider:before {
             transform: translateX(26px);
         }

         .toggle-text {
             font-size: 14px;
             font-weight: 500;
             color: white;
             white-space: nowrap;
             flex: 1;
         }

         .end-conversation-btn {
             background: #28a745;
             color: white;
             border: none;
             padding: 8px 16px;
             border-radius: 20px;
             cursor: pointer;
             font-size: 14px;
             font-weight: 600;
             transition: all 0.3s ease;
         }

                 .end-conversation-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        /* Enhanced Button Styles */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
        }

        .btn-secondary:active {
            transform: translateY(0);
        }

        .word-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            min-width: 20px;
            text-align: center;
        }

        /* Loading Speech Bubble */
        .ai-thinking {
            display: flex;
            justify-content: flex-start;
            margin: 15px 0;
            animation: fadeIn 0.3s ease-in;
        }

        .thinking-bubble {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 200px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .thinking-dots {
            display: flex;
            gap: 4px;
        }

        .thinking-dots span {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: thinking 1.4s infinite ease-in-out;
        }

        .thinking-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .thinking-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        .thinking-text {
            color: #6c757d;
            font-size: 14px;
            font-weight: 500;
        }

        @keyframes thinking {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Success animation for button */
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
            animation: successPulse 0.6s ease-in-out;
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

         /* New Word Highlighting */
         .new-word {
             color: #dc3545;
             font-weight: 600;
             cursor: help;
             position: relative;
             display: inline-block;
         }

         .new-word.loaded {
             /* Keep this for potential future use */
         }

         .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 10px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: fadeIn 0.3s ease-in;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
        }

        .message.user .message-avatar {
            background: #667eea;
        }

        .message.ai .message-avatar {
            background: #764ba2;
        }

        .message-content {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
        }

        .message.ai .message-content {
            background: #f8f9fa;
            color: #333;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid #eee;
            background: white;
            margin-top: auto;
        }

        .chat-input-form {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .send-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s ease;
        }

        .send-button:hover {
            transform: translateY(-2px);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 18px;
            color: #666;
            font-style: italic;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #fcc;
        }

        /* Vocabulary Styles */
        .vocabulary-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .vocabulary-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .add-word-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-word-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .search-container {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
        }

        .search-input:focus {
            border-color: #667eea;
        }

        .words-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .word-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .word-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .word-text {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .delete-word-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .word-translation {
            color: #666;
            margin-bottom: 8px;
        }

        .word-type {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .word-example {
            color: #888;
            font-style: italic;
            font-size: 14px;
        }

        .word-notes {
            color: #666;
            font-size: 13px;
            margin-top: 8px;
            padding: 8px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 6px;
        }

        /* Review Styles */
        .review-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            width: 100%;
            height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .review-header {
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .review-header-left h1 {
            margin: 0 0 4px 0;
            font-size: 24px;
            font-weight: 600;
            color: #212529;
        }

        .review-progress {
            color: #6c757d;
            font-size: 14px;
            font-weight: 500;
        }

        .review-header-right {
            display: flex;
            align-items: center;
        }

        .review-stats {
            display: flex;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 8px 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .stat-number {
            display: block;
            font-size: 18px;
            font-weight: 700;
            color: #212529;
        }

        .stat-label {
            display: block;
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        .review-card {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            background: #f8f9fa;
            position: relative;
        }

        .card-front, .card-back {
            background: white;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            max-width: 500px;
            width: 100%;
            border: 1px solid #e9ecef;
            position: relative;
            z-index: 1;
        }

        .card-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }

        .word-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .word-display h2 {
            margin: 0;
            font-size: 36px;
            font-weight: 700;
            color: #212529;
            letter-spacing: -0.5px;
        }

        .word-type-badge {
            background: #e9ecef;
            color: #495057;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .show-answer-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .show-answer-btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .btn-icon {
            font-size: 18px;
        }

        .btn-text {
            font-size: 16px;
        }

        .answer-section {
            margin-bottom: 32px;
        }

        .translation-section {
            margin-bottom: 24px;
        }

        .translation-section h3 {
            margin: 0 0 12px 0;
            font-size: 18px;
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .translation-section p {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
            color: #212529;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .example-section h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .example-section p {
            margin: 0;
            font-size: 16px;
            color: #495057;
            font-style: italic;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .quality-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .review-header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }
            
            .review-stats {
                gap: 12px;
            }
            
            .card-front, .card-back {
                padding: 24px;
                margin: 0 16px;
            }
            
            .word-display h2 {
                font-size: 28px;
            }
            
            .quality-buttons {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .quality-btn {
                min-height: 60px;
                padding: 12px 8px;
            }
            
            .review-card {
                padding: 20px;
            }
            
            .no-reviews {
                padding: 20px;
            }
        }

        .quality-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 16px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-height: 80px;
            justify-content: center;
            border: 2px solid transparent;
        }

        .quality-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .quality-btn.again { 
            background: #dc3545; 
            border-color: #c82333;
        }
        .quality-btn.hard { 
            background: #fd7e14; 
            border-color: #e55a00;
        }
        .quality-btn.good { 
            background: #28a745; 
            border-color: #1e7e34;
        }
        .quality-btn.easy { 
            background: #17a2b8; 
            border-color: #117a8b;
        }

        .btn-label {
            font-size: 14px;
            font-weight: 600;
        }

        .btn-preview {
            font-size: 11px;
            opacity: 0.8;
            font-weight: 500;
        }

        .no-reviews {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
        }

        .no-reviews-content {
            text-align: center;
            padding: 40px;
        }

        .no-reviews-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .no-reviews h3 {
            margin: 0 0 8px 0;
            font-size: 24px;
            font-weight: 600;
            color: #212529;
        }

        .no-reviews p {
            margin: 0 0 4px 0;
            color: #6c757d;
            font-size: 16px;
        }

        .no-reviews .subtitle {
            font-size: 14px;
            color: #adb5bd;
            margin-top: 8px;
        }

        /* Stats Styles - New Design */
        .stats-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .stats-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
        }

        .stats-header h1 {
            font-size: 1.3rem;
            margin: 0;
        }

        .stats-overview {
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #dee2e6;
        }

        .overview-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .overview-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-top: 3px solid #667eea;
        }

        .overview-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .overview-label {
            color: #666;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stats-details {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stats-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }

        .stats-section.full-width {
            grid-column: 1 / -1;
        }

        .stats-section h3 {
            color: #333;
            font-size: 1rem;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .metric-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            border-left: 3px solid #28a745;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 3px;
        }

        .metric-label {
            color: #666;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .schedule-summary {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            border-radius: 8px;
            padding: 12px;
            border-left: 3px solid #ffc107;
        }

        .schedule-label {
            font-size: 13px;
            color: #333;
            font-weight: 500;
        }

        .schedule-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #ffc107;
        }

        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .forecast-day {
            background: white;
            border-radius: 8px;
            padding: 12px 8px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: all 0.2s ease;
        }

        .forecast-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .forecast-day.today {
            border-color: #dc3545;
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .forecast-day.tomorrow {
            border-color: #ffc107;
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #333;
        }

        .forecast-day.future {
            border-color: #28a745;
        }

        .forecast-date {
            font-size: 10px;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .forecast-count {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .forecast-count.today {
            color: white;
        }

        .forecast-count.tomorrow {
            color: #333;
        }

        .forecast-count.future {
            color: #28a745;
        }

        .forecast-label {
            font-size: 8px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .forecast-label.today {
            color: white;
        }

        .forecast-label.tomorrow {
            color: #333;
        }

        .forecast-label.future {
            color: #28a745;
        }



        .scheduling-info {
            padding: 20px;
            border-top: 1px solid #eee;
            background: #f8f9fa;
        }

        .scheduling-info h3 {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
            font-size: 18px;
        }

        .scheduling-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .schedule-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .schedule-icon {
            font-size: 24px;
        }

        .schedule-text {
            flex: 1;
            font-size: 14px;
        }

        .highlight {
            color: #667eea;
            font-weight: 600;
        }

        .scheduling-note {
            text-align: center;
            color: #666;
            font-size: 14px;
            font-style: italic;
            margin: 0;
        }

        .word-scheduling {
            margin-top: 10px;
        }

        .schedule-info-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .schedule-info-btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Language Learning</h2>
            </div>
            <nav class="sidebar-nav">
                <button class="nav-button active" data-tab="chat">
                    <span class="nav-icon">💬</span>
                    Chat
                </button>
                <button class="nav-button" data-tab="vocabulary">
                    <span class="nav-icon">📚</span>
                    Vocabulary
                </button>
                <button class="nav-button" data-tab="review">
                    <span class="nav-icon">🔄</span>
                    Review
                </button>
                <button class="nav-button" data-tab="stats">
                    <span class="nav-icon">📊</span>
                    Stats
                </button>
            </nav>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Chat Tab -->
            <div class="tab-content active" id="chat-tab">
                <div class="chat-container">
                                         <div class="chat-header">
                         <h1>AI Italian Tutor</h1>
                         <div class="chat-controls">
                             <div class="vocabulary-toggle">
                                 <label class="toggle-label">
                                     <div class="toggle-switch">
                                         <input type="checkbox" id="vocabularyToggle">
                                         <span class="toggle-slider"></span>
                                     </div>
                                     <span class="toggle-text">Learning Mode: ON (1-5 new words)</span>
                                 </label>
                             </div>
                         </div>
                     </div>
                    
                    <div class="chat-messages" id="chatMessages">
                        <div class="message ai">
                            <div class="message-avatar">AI</div>
                            <div class="message-content">
                                Ciao! Sono il tuo tutor di italiano. Come posso aiutarti oggi?
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading indicator -->
                    <div id="aiThinking" class="ai-thinking" style="display: none;">
                        <div class="thinking-bubble">
                            <div class="thinking-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                            <span class="thinking-text">AI is thinking...</span>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <form class="chat-input-form" id="chatForm">
                            <input 
                                type="text" 
                                class="chat-input" 
                                id="messageInput" 
                                placeholder="Scrivi il tuo messaggio qui..."
                                autocomplete="off"
                            >
                            <button type="submit" class="send-button" id="sendButton">
                                Invia
                            </button>
                        </form>
                        
                        <!-- New words management buttons -->
                        <div class="new-words-controls" style="margin-top: 10px; text-align: center;">
                            <button id="addNewWordsBtn" class="btn btn-primary" onclick="addNewWords()" style="display: none;">
                                <span class="btn-text">➕ Add New Words</span>
                                <span class="word-count" id="newWordCount">(0)</span>
                            </button>
                            <button id="endConversationBtn" class="btn btn-secondary" onclick="endConversation()" style="display: none; margin-left: 10px;">
                                🔚 End Conversation
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vocabulary Tab -->
            <div class="tab-content" id="vocabulary-tab">
                <div class="vocabulary-container">
                    <div class="vocabulary-header">
                        <h1>Vocabulary Manager</h1>
                        <button class="add-word-btn" id="addWordBtn">+ Add Word</button>
                    </div>
                    
                    <div class="search-container">
                        <input type="text" id="searchInput" placeholder="Search words..." class="search-input">
                    </div>
                    
                                         <div class="words-list" id="wordsList">
                         <!-- Words will be loaded here -->
                     </div>
                     

                 </div>
             </div>

            <!-- Review Tab -->
            <div class="tab-content" id="review-tab">
                <div class="review-container">
                    <div class="review-header">
                        <div class="review-header-left">
                            <h1>Review</h1>
                            <div class="review-progress">
                                <span id="dueCount">0</span> words due for review
                            </div>
                        </div>
                        <div class="review-header-right">
                            <div class="review-stats">
                                <div class="stat-item">
                                    <span class="stat-number" id="totalWords">0</span>
                                    <span class="stat-label">Total</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number" id="accuracyRate">0%</span>
                                    <span class="stat-label">Accuracy</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="review-card" id="reviewCard" style="display: none;">
                        <div class="card-front">
                            <div class="card-content">
                                <div class="word-display">
                                    <h2 id="reviewWord">Word</h2>
                                    <div class="word-type-badge" id="wordTypeBadge" style="display: none;">
                                        <span id="reviewWordType">noun</span>
                                    </div>
                                </div>
                                <button class="show-answer-btn" id="showAnswerBtn">
                                    <span class="btn-icon">👁️</span>
                                    <span class="btn-text">Show Answer</span>
                                </button>
                            </div>
                        </div>
                        <div class="card-back" id="cardBack" style="display: none;">
                            <div class="answer-section">
                                <div class="translation-section">
                                    <h3>Translation</h3>
                                    <p id="reviewTranslation">Translation</p>
                                </div>
                                <div class="example-section" id="exampleSection" style="display: none;">
                                    <h4>Example</h4>
                                    <p id="reviewExample">Example</p>
                                </div>
                            </div>
                            <div class="quality-buttons">
                                <button class="quality-btn again" data-quality="0">
                                    <span class="btn-icon">😞</span>
                                    <span class="btn-label">Again</span>
                                    <span class="btn-preview" id="preview-0"></span>
                                </button>
                                <button class="quality-btn hard" data-quality="1">
                                    <span class="btn-icon">😐</span>
                                    <span class="btn-label">Hard</span>
                                    <span class="btn-preview" id="preview-1"></span>
                                </button>
                                <button class="quality-btn good" data-quality="2">
                                    <span class="btn-icon">🙂</span>
                                    <span class="btn-label">Good</span>
                                    <span class="btn-preview" id="preview-2"></span>
                                </button>
                                <button class="quality-btn easy" data-quality="3">
                                    <span class="btn-icon">😊</span>
                                    <span class="btn-label">Easy</span>
                                    <span class="btn-preview" id="preview-3"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="no-reviews" id="noReviews">
                        <div class="no-reviews-content">
                            <div class="no-reviews-icon">🎉</div>
                            <h3>No words due for review!</h3>
                            <p>Great job! You're all caught up.</p>
                            <p class="subtitle">Add some new words to continue learning.</p>
                        </div>
                    </div>
                </div>
            </div>

                                      <!-- Stats Tab -->
              <div class="tab-content" id="stats-tab">
                  <div class="stats-container">
                      <div class="stats-header">
                          <h1>Learning Statistics</h1>
                      </div>
                      
                      <div class="stats-overview" id="statsOverview">
                          <!-- Main stats overview will be loaded here -->
                      </div>
                      
                      <div class="stats-details">
                          <div class="stats-row">
                              <div class="stats-section">
                                  <h3>📊 Performance Metrics</h3>
                                  <div class="metrics-grid" id="metricsGrid">
                                      <!-- Performance metrics will be loaded here -->
                                  </div>
                              </div>
                              
                              <div class="stats-section">
                                  <h3>📅 Review Schedule</h3>
                                  <div class="schedule-summary" id="scheduleSummary">
                                      <!-- Schedule summary will be loaded here -->
                                  </div>
                              </div>
                          </div>
                          
                          <div class="stats-section full-width">
                              <h3>📈 Daily Review Forecast</h3>
                              <div class="forecast-grid" id="forecastGrid">
                                  <!-- Daily forecast will be loaded here -->
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
        </div>
    </div>

    <script>
        // Get DOM elements
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const chatMessages = document.getElementById('chatMessages');
        const vocabularyToggle = document.getElementById('vocabularyToggle');
        const addNewWordsBtn = document.getElementById('addNewWordsBtn');
        const endConversationBtn = document.getElementById('endConversationBtn');
        
        // Check if elements exist
        if (!messageInput || !sendButton || !chatMessages) {
            console.error('❌ Required chat elements not found:', {
                messageInput: !!messageInput,
                sendButton: !!sendButton,
                chatMessages: !!chatMessages
            });
        } else {
            // Add event listeners
            sendButton.addEventListener('click', () => {
                const message = messageInput.value.trim();
                if (message) {
                    addMessage(message, true);
                    messageInput.value = '';
                    sendMessage(message);
                }
            });
            
            // Allow Enter key to send message
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const message = messageInput.value.trim();
                    if (message) {
                        addMessage(message, true);
                        messageInput.value = '';
                        sendMessage(message);
                    }
                }
            });
        }

                 function addMessage(content, isUser = false) {
             const messageDiv = document.createElement('div');
             messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
             
             const avatar = document.createElement('div');
             avatar.className = 'message-avatar';
             avatar.textContent = isUser ? 'You' : 'AI';
             
             const messageContent = document.createElement('div');
             messageContent.className = 'message-content';
             
             // Handle HTML content for AI responses (to show highlighted new words)
             if (isUser) {
                 messageContent.textContent = content;
             } else {
                 messageContent.innerHTML = content;
             }
             
             messageDiv.appendChild(avatar);
             messageDiv.appendChild(messageContent);
             
             chatMessages.appendChild(messageDiv);
             chatMessages.scrollTop = chatMessages.scrollHeight;
         }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            chatMessages.appendChild(errorDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

                         async function sendMessage(message) {
            try {
                sendButton.disabled = true;
                sendButton.textContent = 'Sending...';
                
                // Show loading indicator
                const aiThinking = document.getElementById('aiThinking');
                aiThinking.style.display = 'flex';
                
                                 // Get current vocabulary state
                 const toggleElement = document.getElementById('vocabularyToggle');
                 if (!toggleElement) {
                     console.error('❌ Vocabulary toggle not found in DOM');
                     showError('Vocabulary toggle not found. Please refresh the page.');
                     return;
                 }
                 const isStrictMode = toggleElement.checked;
                
                console.log('📤 Sending message with settings:');
                console.log('  - Strict Mode:', isStrictMode);
                console.log('  - Vocabulary Size:', currentVocabulary.length);
                console.log('  - Available Words:', currentVocabulary);
                console.log('  - Message:', message);
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        message: message,
                        strict_mode: isStrictMode,
                        current_vocabulary: currentVocabulary
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    console.log('📥 AI Response received:', data.response);
                    
                    // Hide loading indicator
                    aiThinking.style.display = 'none';
                    
                    // Process AI response to highlight new words
                    const processedResponse = processAIResponse(data.response);
                    addMessage(processedResponse, false);
                    
                    // Show end conversation button if new words were introduced
                    if (newWordsIntroduced.size > 0) {
                        document.getElementById('endConversationBtn').style.display = 'block';
                    }
                } else {
                    // Hide loading indicator on error
                    aiThinking.style.display = 'none';
                    showError(data.error || 'Failed to get response from AI');
                }
            } catch (error) {
                // Hide loading indicator on error
                aiThinking.style.display = 'none';
                showError('Network error. Please check your connection.');
                console.error('Error:', error);
            } finally {
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
            }
        }

                // Function to get AI translation for a word
        async function getAITranslation(word, context = '') {
            console.log('🤖 Getting AI translation for word:', word);
            try {
                const requestBody = {
                    word: word,
                    context: context
                };
                
                const response = await fetch('/api/sr/ai-translate-word', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        console.log('🤖 AI translation successful:', word, '->', data.translation);
                        return data.translation;
                    }
                }
                
                console.warn('⚠️ AI translation failed, will use Google Translate');
                return null;
                
            } catch (error) {
                console.error('💥 AI translation error:', error);
                return null;
            }
        }

        // Function to get context-aware translation for a word (enhanced with AI)
        async function getContextAwareTranslation(word, context = '') {
            console.log('🔍 Starting translation for word:', word);
            
            // Try AI translation first
            const aiTranslation = await getAITranslation(word, context);
            if (aiTranslation) {
                return aiTranslation;
            }
            
            // Fallback to Google Translate
            try {
                const requestBody = {
                    word: word,
                    context: context
                };
                console.log('📤 Sending Google Translate request:', requestBody);
                
                const response = await fetch('/api/sr/ai-translate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('📥 Translation response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('📥 Translation response data:', data);
                    
                    if (data.success) {
                        console.log('✅ Google Translate successful:', word, '->', data.translation);
                        return data.translation;
                    } else {
                        console.warn('⚠️ Google Translate failed:', data.error);
                        return `[${word}]`;
                    }
                } else {
                    console.error('❌ Translation request failed with status:', response.status);
                    const errorText = await response.text();
                    console.error('❌ Error response body:', errorText);
                    return `[${word}]`;
                }
            } catch (error) {
                console.error('💥 Translation error:', error);
                return `[${word}]`;
            }
        }

        // Function to process AI response and highlight new words
        function processAIResponse(response) {
            // Filter out ATTENZIONE warning messages
            if (response.includes('⚠️ ATTENZIONE:')) {
                const startIndex = response.indexOf('Ecco la mia risposta:');
                if (startIndex !== -1) {
                    response = response.substring(startIndex + 'Ecco la mia risposta:'.length).trim();
                }
            }
            
            // Enhanced patterns to catch all Italian words including short ones and accented characters
            const patterns = [
                // Full words with accents - comprehensive character set
                '\\b[aàbcdeèéfghiìjklmnoòpqrstuùvxyz]\\w*\\b',
                // Single characters including all accented ones
                '\\b[aàbcdeèéfghiìjklmnoòpqrstuùvxyz]\\b',
                // Words with apostrophes (like "dell'acqua")
                '\\b[aàbcdeèéfghiìjklmnoòpqrstuùvxyz]\'[aàbcdeèéfghiìjklmnoòpqrstuùvxyz]\\w*\\b',
                // Two-character combinations
                '\\b[aàbcdeèéfghiìjklmnoòpqrstuùvxyz][aàbcdeèéfghiìjklmnoòpqrstuùvxyz]\\b',
                // Standalone accented characters
                '\\b[àèéìòù]\\b',
                // Very short words (1-2 chars)
                '\\b[aàbcdeèéfghiìjklmnoòpqrstuùvxyz]{1,2}\\b',
                // Special pattern for words ending with accented characters
                '\\b\\w*[àèéìòù]\\b',
                // Pattern for words starting with accented characters
                '\\b[àèéìòù]\\w*\\b',
                // Catch any word that contains accented characters (fallback)
                '\\b\\w*[àèéìòù]\\w*\\b'
            ];
            
            let processedResponse = response;
            const newWordsFound = [];
            
            // Process each pattern
            patterns.forEach((pattern, index) => {
                const regex = new RegExp(pattern, 'gi');
                const matches = processedResponse.match(regex);
                
                if (matches) {
                    console.log(`🔍 Pattern ${index + 1} (${pattern}): Found matches:`, matches);
                    matches.forEach(match => {
                        const lowerMatch = match.toLowerCase();
                        
                        // Check if this word is not in current vocabulary
                        if (!currentVocabulary.some(vocabWord => 
                            vocabWord.toLowerCase() === lowerMatch
                        )) {
                            // Check if we haven't already found this word
                            if (!newWordsFound.some(w => w.word.toLowerCase() === lowerMatch)) {
                                console.log(`✨ New word detected: "${match}" (pattern ${index + 1})`);
                                newWordsFound.push({
                                    word: match,
                                    original: match,
                                    translation: null
                                });
                                
                                // Add to newWords array for later processing
                                if (!newWords.some(w => w.word.toLowerCase() === lowerMatch)) {
                                    newWords.push({
                                        word: match,
                                        original: match,
                                        translation: null
                                    });
                                }
                            }
                        }
                    });
                }
            });
            
            console.log(`🎯 Total new words found: ${newWordsFound.length}`, newWordsFound.map(w => w.word));
            
            // Highlight new words in the response (red text instead of red bubbles)
            newWordsFound.forEach(wordObj => {
                const regex = new RegExp(`\\b${wordObj.word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi');
                processedResponse = processedResponse.replace(regex, 
                    `<span class="new-word" data-word="${wordObj.word}" style="color: red; font-weight: bold;">${wordObj.word}</span>`
                );
            });
            
            // Fetch translations for new words
            newWordsFound.forEach(async (wordObj) => {
                try {
                    const translation = await getContextAwareTranslation(wordObj.word);
                    wordObj.translation = translation;
                    
                    // Update the newWords array
                    const existingWord = newWords.find(w => w.word.toLowerCase() === wordObj.word.toLowerCase());
                    if (existingWord) {
                        existingWord.translation = translation;
                    }
                    
                    // Update tooltip - show multiple translations if available
                    const spans = document.querySelectorAll(`[data-word="${wordObj.word}"]`);
                    spans.forEach(span => {
                        // Check if we have multiple translations (comma-separated)
                        if (translation && translation.includes(',')) {
                            // Show up to 3 translations in tooltip
                            const translations = translation.split(',').map(t => t.trim()).slice(0, 3);
                            const tooltipText = translations.join('\n');
                            span.title = tooltipText;
                        } else {
                            span.title = translation;
                        }
                        span.style.animation = 'none'; // Stop pulsing
                    });
                } catch (error) {
                    console.error('Error fetching translation for', wordObj.word, error);
                }
            });
            
            // Show "Add New Words" button if new words were found
            if (newWordsFound.length > 0) {
                const addNewWordsBtn = document.getElementById('addNewWordsBtn');
                const endConversationBtn = document.getElementById('endConversationBtn');
                if (addNewWordsBtn && endConversationBtn) {
                    addNewWordsBtn.style.display = 'inline-block';
                    endConversationBtn.style.display = 'inline-block';
                    // Update the word count display
                    document.getElementById('newWordCount').textContent = `(${newWordsFound.length})`;
                } else {
                    console.warn('Add New Words or End Conversation button not found in DOM');
                }
            }
            
            return processedResponse;
        }

         // End conversation and add new words
         document.getElementById('endConversationBtn').addEventListener('click', async () => {
             if (newWordsIntroduced.size === 0) {
                 alert('No new words to add!');
                 return;
             }
             
             const confirmed = confirm(`Add ${newWordsIntroduced.size} new words to your vocabulary?`);
             if (!confirmed) return;
             
             try {
                 let addedCount = 0;
                 
                 for (const word of newWordsIntroduced) {
                     const wordData = newWordsData.get(word);
                     if (wordData) {
                         await addWord(word, wordData.translation, wordData.example, wordData.word_type, '');
                         addedCount++;
                     }
                 }
                 
                 // Clear the conversation state
                 newWordsIntroduced.clear();
                 newWordsData.clear();
                 
                 const endConversationBtn = document.getElementById('endConversationBtn');
                 if (endConversationBtn) {
                     endConversationBtn.style.display = 'none';
                 }
                 
                 // Reload vocabulary for chat
                 await loadCurrentVocabulary();
                 
                 alert(`Successfully added ${addedCount} new words to your vocabulary!`);
                 
             } catch (error) {
                 console.error('Error adding new words:', error);
                 alert('Error adding new words. Please try again.');
             }
         });

         // Initialize vocabulary when page loads
         document.addEventListener('DOMContentLoaded', () => {
             loadCurrentVocabulary();
             
             // Set initial toggle label
             const toggleLabel = document.querySelector('.toggle-text');
             if (toggleLabel) {
                 toggleLabel.textContent = 'Learning Mode: ON (1-5 new words)';
                 toggleLabel.style.color = '#ffc107';
             } else {
                 console.warn('⚠️ Toggle label not found during initialization');
             }
             
             // Set up toggle event listener
             const toggleElement = document.getElementById('vocabularyToggle');
             if (toggleElement) {
                 toggleElement.addEventListener('change', () => {
                     // Reset conversation when changing modes
                     resetConversation();
                     
                     // Update toggle label to show current mode
                     const toggleLabel = document.querySelector('.toggle-text');
                     if (toggleLabel) {
                         const isStrictMode = toggleElement.checked;
                         if (isStrictMode) {
                             toggleLabel.textContent = 'Strict Mode: ON';
                             toggleLabel.style.color = '#28a745';
                             console.log('🟢 STRICT MODE ENABLED - AI should use ONLY vocabulary words');
                         } else {
                             toggleLabel.textContent = 'Learning Mode: ON';
                             toggleLabel.style.color = '#ffc107';
                             console.log('🟡 LEARNING MODE ENABLED - AI can introduce 1-5 new words');
                         }
                     }
                     
                     // Log current vocabulary for debugging
                     console.log('Current vocabulary for AI:', currentVocabulary);
                 });
             } else {
                 console.warn('⚠️ Vocabulary toggle not found during initialization');
             }
         });

         // Reset conversation state when starting fresh
         function resetConversation() {
             newWordsIntroduced.clear();
             newWordsData.clear();
             
             const endConversationBtn = document.getElementById('endConversationBtn');
             if (endConversationBtn) {
                 endConversationBtn.style.display = 'none';
             }
             
             // Clear chat messages except the initial greeting
             const chatMessages = document.getElementById('chatMessages');
             const initialMessage = chatMessages.querySelector('.message.ai');
             chatMessages.innerHTML = '';
             if (initialMessage) {
                 chatMessages.appendChild(initialMessage);
             }
         }

         // Add reset button functionality (will be set up in DOMContentLoaded)

         // Tab Navigation
         const navButtons = document.querySelectorAll('.nav-button');
        const tabContents = document.querySelectorAll('.tab-content');

        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.getAttribute('data-tab');
                
                // Update active states
                navButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(tab => tab.classList.remove('active'));
                
                button.classList.add('active');
                document.getElementById(`${targetTab}-tab`).classList.add('active');
                
                // Load content based on tab
                if (targetTab === 'vocabulary') {
                    loadVocabulary();
                } else if (targetTab === 'review') {
                    loadReview();
                } else if (targetTab === 'stats') {
                    loadStats();
                }
            });
        });

                 // Spaced Repetition System
         let currentReviewWord = null;
         let reviewWords = [];

         // Vocabulary-Aware Chat System
         let currentVocabulary = [];
         let newWords = [];
         let newWordsIntroduced = new Set();
         let newWordsData = new Map(); // word -> {translation, example, word_type}

                 // Load current vocabulary for chat system
         async function loadCurrentVocabulary() {
             try {
                 console.log('🔄 Loading current vocabulary for chat system...');
                 const response = await fetch('/api/sr/words');
                 const data = await response.json();
                 
                 if (response.ok) {
                     currentVocabulary = data.words.map(word => word.word.toLowerCase());
                     console.log('✅ Vocabulary loaded successfully:');
                     console.log('  - Total words:', currentVocabulary.length);
                     console.log('  - Words:', currentVocabulary);
                     
                     // Update toggle label if page is already loaded
                     const toggleLabel = document.querySelector('.toggle-text');
                     const toggleElement = document.getElementById('vocabularyToggle');
                     if (toggleLabel && toggleElement) {
                         const isStrictMode = toggleElement.checked;
                         if (isStrictMode) {
                             toggleLabel.textContent = 'Strict Mode: ON';
                             toggleLabel.style.color = '#28a745';
                         } else {
                             toggleLabel.textContent = 'Learning Mode: ON';
                             toggleLabel.style.color = '#ffc107';
                         }
                     }
                 } else {
                     console.error('❌ Failed to load vocabulary:', data.error);
                 }
             } catch (error) {
                 console.error('❌ Error loading vocabulary for chat:', error);
             }
         }

         // Vocabulary Management
         async function loadVocabulary() {
            try {
                const response = await fetch('/api/sr/words');
                const data = await response.json();
                
                if (response.ok) {
                    displayWords(data.words);
                } else {
                    console.error('Failed to load words:', data.error);
                }
            } catch (error) {
                console.error('Error loading vocabulary:', error);
            }
        }

        function displayWords(words) {
            const wordsList = document.getElementById('wordsList');
            wordsList.innerHTML = '';
            
            if (words.length === 0) {
                wordsList.innerHTML = '<p style="text-align: center; color: #666; margin-top: 40px;">No words added yet. Add your first word to get started!</p>';
                return;
            }
            
            words.forEach(word => {
                const wordElement = document.createElement('div');
                wordElement.className = 'word-item';
                wordElement.innerHTML = `
                    <div class="word-header">
                        <span class="word-text">${word.word}</span>
                        <button class="delete-word-btn" onclick="deleteWord('${word.id}')">Delete</button>
                    </div>
                    <div class="word-translation">${word.translation}</div>
                                                              ${word.word_type ? `<div class="word-type">${word.word_type}</div>` : ''}
                     ${word.example ? `<div class="word-example">"${word.example}"</div>` : ''}
                     ${word.notes ? `<div class="word-notes">${word.notes}</div>` : ''}
                     <div class="word-scheduling">
                         <button class="schedule-info-btn" onclick="showScheduleInfo('${word.id}')">
                             📅 Show Review Schedule
                         </button>
                     </div>
                 `;
                 wordsList.appendChild(wordElement);
             });
         }

        async function deleteWord(wordId) {
            if (!confirm('Are you sure you want to delete this word?')) return;
            
            try {
                const response = await fetch(`/api/sr/words/${wordId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadVocabulary(); // Reload the list
                } else {
                    console.error('Failed to delete word');
                }
            } catch (error) {
                console.error('Error deleting word:', error);
            }
        }

        // Add Word Modal
        document.getElementById('addWordBtn').addEventListener('click', async () => {
            const word = prompt('Enter the Italian word:');
            if (!word) return;
            
            // Use AI to get translation, example, and word type
            try {
                const response = await fetch('/api/sr/ai-translate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ word: word })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show the AI-generated content and allow editing
                    const translation = prompt(`Translation: ${data.translation}\n\nEdit if needed:`, data.translation);
                    if (!translation) return;
                    
                    const example = prompt(`Example sentence: ${data.example}\n\nEdit if needed:`, data.example);
                    const wordType = prompt(`Word type: ${data.word_type}\n\nEdit if needed:`, data.word_type);
                    const notes = prompt('Additional notes (optional):');
                    
                    addWord(word, translation, example, wordType, notes);
                } else {
                    // Fallback to manual entry if AI fails
                    const translation = prompt('AI translation failed. Enter translation manually:');
                    if (!translation) return;
                    
                    const example = prompt('Enter an example sentence (optional):');
                    const wordType = prompt('Enter word type (verb, noun, adjective, etc.):');
                    const notes = prompt('Enter notes (optional):');
                    
                    addWord(word, translation, example, wordType, notes);
                }
            } catch (error) {
                console.error('Error getting AI translation:', error);
                // Fallback to manual entry
                const translation = prompt('Enter the translation:');
                if (!translation) return;
                
                const example = prompt('Enter an example sentence (optional):');
                const wordType = prompt('Enter word type (verb, noun, adjective, etc.):');
                const notes = prompt('Enter notes (optional):');
                
                addWord(word, translation, example, wordType, notes);
            }
        });

        async function addWord(word, translation, example = '', word_type = '', notes = '') {
            try {
                const response = await fetch('/api/sr/words', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ word, translation, example, word_type, notes })
                })
                
                const data = await response.json();
                
                if (response.ok) {
                    loadVocabulary(); // Reload the list
                } else {
                    alert('Failed to add word: ' + data.error);
                }
            } catch (error) {
                console.error('Error adding word:', error);
                alert('Error adding word');
            }
        }

        // Review System
        async function loadReview() {
            try {
                console.log('Loading review words...');
                const response = await fetch('/api/sr/due');
                const data = await response.json();
                
                console.log('Review response:', response.status, data);
                
                if (response.ok) {
                    reviewWords = data.words;
                    console.log('Review words loaded:', reviewWords);
                    document.getElementById('dueCount').textContent = reviewWords.length;
                    
                    // Load stats for the header
                    await loadReviewStats();
                    
                    if (reviewWords.length > 0) {
                        console.log('Starting review with word:', reviewWords[0]);
                        startReview();
                    } else {
                        console.log('No words to review, showing no reviews message');
                        showNoReviews();
                    }
                } else {
                    console.error('Failed to load review words:', data.error);
                }
            } catch (error) {
                console.error('Error loading review:', error);
            }
        }

        async function loadReviewStats() {
            try {
                const response = await fetch('/api/sr/stats');
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalWords').textContent = stats.total_words || 0;
                    document.getElementById('accuracyRate').textContent = (stats.accuracy || 0) + '%';
                }
            } catch (error) {
                console.error('Error loading review stats:', error);
            }
        }

        function startReview() {
            currentReviewWord = reviewWords[0];
            console.log('Starting review for word:', currentReviewWord);
            
            document.getElementById('reviewCard').style.display = 'block';
            document.getElementById('noReviews').style.display = 'none';
            
            document.getElementById('reviewWord').textContent = currentReviewWord.word;
            document.getElementById('cardBack').style.display = 'none';
            document.getElementById('showAnswerBtn').style.display = 'flex';
            
            // Show word type badge if available
            const wordTypeBadge = document.getElementById('wordTypeBadge');
            const reviewWordType = document.getElementById('reviewWordType');
            if (currentReviewWord.word_type) {
                reviewWordType.textContent = currentReviewWord.word_type;
                wordTypeBadge.style.display = 'block';
            } else {
                wordTypeBadge.style.display = 'none';
            }
            
            console.log('Review card displayed, loading preview...');
            // Load preview for this word
            loadReviewPreview(currentReviewWord.id);
        }

        async function loadReviewPreview(wordId) {
            try {
                const response = await fetch(`/api/sr/words/${wordId}/review-preview`);
                if (response.ok) {
                    const data = await response.json();
                    displayReviewPreview(data.preview);
                }
            } catch (error) {
                console.error('Error loading review preview:', error);
            }
        }

        function displayReviewPreview(preview) {
            // Clear previous previews
            for (let i = 0; i < 4; i++) {
                const previewElement = document.getElementById(`preview-${i}`);
                if (previewElement) {
                    previewElement.textContent = '';
                }
            }
            
            // Display previews for each quality level
            if (preview['Again (0)']) {
                document.getElementById('preview-0').textContent = preview['Again (0)'].human_readable;
            }
            if (preview['Again (1)']) {
                document.getElementById('preview-1').textContent = preview['Again (1)'].human_readable;
            }
            if (preview['Hard (2)']) {
                document.getElementById('preview-2').textContent = preview['Hard (2)'].human_readable;
            }
            if (preview['Good (3)']) {
                document.getElementById('preview-3').textContent = preview['Good (3)'].human_readable;
            }
        }

        function showNoReviews() {
            document.getElementById('reviewCard').style.display = 'none';
            document.getElementById('noReviews').style.display = 'block';
        }

        document.getElementById('showAnswerBtn').addEventListener('click', () => {
            document.getElementById('cardBack').style.display = 'block';
            document.getElementById('reviewTranslation').textContent = currentReviewWord.translation;
            
            if (currentReviewWord.example) {
                document.getElementById('exampleSection').style.display = 'block';
                document.getElementById('reviewExample').textContent = currentReviewWord.example;
            } else {
                document.getElementById('exampleSection').style.display = 'none';
            }
            
            // Hide the show answer button
            document.getElementById('showAnswerBtn').style.display = 'none';
        });

        // Quality buttons
        document.querySelectorAll('.quality-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const quality = parseInt(btn.getAttribute('data-quality'));
                reviewWord(quality);
            });
        });



        async function reviewWord(quality) {
            try {
                const response = await fetch('/api/sr/review', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        word_id: currentReviewWord.id,
                        quality: quality
                    })
                });
                
                if (response.ok) {
                    // Remove the reviewed word from the list
                    reviewWords.shift();
                    
                    if (reviewWords.length > 0) {
                        startReview(); // Start next word
                    } else {
                        showNoReviews(); // No more words to review
                    }
                }
            } catch (error) {
                console.error('Error reviewing word:', error);
            }
        }

        // Stats
        async function loadStats() {
            console.log('Loading stats...'); // Debug log
            
            try {
                const response = await fetch('/api/sr/stats');
                const stats = await response.json();
                
                console.log('Stats response:', response.status, stats); // Debug log
                
                if (response.ok) {
                    displayStats(stats);
                } else {
                    console.error('Failed to load stats:', stats.error);
                    // Show error in the stats sections
                    showStatsError('Failed to load statistics');
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                showStatsError('Network error loading statistics');
            }
            
            // Also load daily upcoming counts
            try {
                const dailyResponse = await fetch('/api/sr/daily-upcoming?days=7');
                const dailyData = await dailyResponse.json();
                
                console.log('Daily response:', dailyResponse.status, dailyData); // Debug log
                
                if (dailyResponse.ok) {
                    displayDailyUpcomingCounts(dailyData.daily_counts);
                } else {
                    console.error('Failed to load daily counts:', dailyData.error);
                    showDailyCountsError('Failed to load daily forecast');
                }
            } catch (error) {
                console.error('Error loading daily upcoming counts:', error);
                showDailyCountsError('Network error loading daily forecast');
            }
        }

        function showStatsError(message) {
            const statsOverview = document.getElementById('statsOverview');
            const metricsGrid = document.getElementById('metricsGrid');
            const scheduleSummary = document.getElementById('scheduleSummary');
            
            if (statsOverview) {
                statsOverview.innerHTML = `<div style="text-align: center; color: #dc3545; padding: 20px;">${message}</div>`;
            }
            if (metricsGrid) {
                metricsGrid.innerHTML = `<div style="text-align: center; color: #dc3545; padding: 20px;">${message}</div>`;
            }
            if (scheduleSummary) {
                scheduleSummary.innerHTML = `<div style="text-align: center; color: #dc3545; padding: 20px;">${message}</div>`;
            }
        }

        function showDailyCountsError(message) {
            const forecastGrid = document.getElementById('forecastGrid');
            if (forecastGrid) {
                forecastGrid.innerHTML = `<div style="text-align: center; color: #dc3545; padding: 20px;">${message}</div>`;
            }
        }

        function displayStats(stats) {
            console.log('Displaying stats:', stats); // Debug log
            
            // Display overview cards
            const statsOverview = document.getElementById('statsOverview');
            if (statsOverview) {
                statsOverview.innerHTML = `
                    <div class="overview-cards">
                        <div class="overview-card">
                            <div class="overview-number">${stats.total_words || 0}</div>
                            <div class="overview-label">Total Words</div>
                        </div>
                        <div class="overview-card">
                            <div class="overview-number">${stats.due_words || 0}</div>
                            <div class="overview-label">Words Due</div>
                        </div>
                        <div class="overview-card">
                            <div class="overview-number">${stats.total_reviews || 0}</div>
                            <div class="overview-label">Total Reviews</div>
                        </div>
                        <div class="overview-card">
                            <div class="overview-number">${stats.accuracy || 0}%</div>
                            <div class="overview-label">Accuracy</div>
                        </div>
                    </div>
                `;
            }

            // Display performance metrics
            const metricsGrid = document.getElementById('metricsGrid');
            if (metricsGrid) {
                const avgReviewsPerWord = stats.total_reviews > 0 && stats.total_words > 0 ? (stats.total_reviews / stats.total_words).toFixed(1) : '0';
                const successRate = stats.total_reviews > 0 ? stats.accuracy || 0 : 0;
                
                metricsGrid.innerHTML = `
                    <div class="metric-item">
                        <div class="metric-value">${avgReviewsPerWord}</div>
                        <div class="metric-label">Avg Reviews/Word</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value">${successRate}%</div>
                        <div class="metric-label">Success Rate</div>
                    </div>
                `;
            }

            // Display schedule summary
            const scheduleSummary = document.getElementById('scheduleSummary');
            if (scheduleSummary) {
                const nextReview = stats.due_words > 0 ? 'Now' : 'Later';
                const urgency = stats.due_words > 5 ? 'High' : stats.due_words > 2 ? 'Medium' : 'Low';
                
                scheduleSummary.innerHTML = `
                    <div class="schedule-item">
                        <span class="schedule-label">Next Review</span>
                        <span class="schedule-value">${nextReview}</span>
                    </div>
                    <div class="schedule-item">
                        <span class="schedule-label">Urgency Level</span>
                        <span class="schedule-value">${urgency}</span>
                    </div>
                    <div class="schedule-item">
                        <span class="schedule-label">Learning Pace</span>
                        <span class="schedule-value">${stats.total_reviews > 0 ? 'Active' : 'Starting'}</span>
                    </div>
                `;
            }
        }

        function displayDailyUpcomingCounts(dailyCounts) {
            console.log('Displaying daily counts:', dailyCounts); // Debug log
            
            const forecastGrid = document.getElementById('forecastGrid');
            if (!forecastGrid) {
                console.error('Forecast grid element not found');
                return;
            }
            
            if (!dailyCounts || dailyCounts.length === 0) {
                forecastGrid.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1 / -1;">No upcoming reviews in the next 7 days! 🎉</p>';
                return;
            }
            
            forecastGrid.innerHTML = '';
            
            dailyCounts.forEach(day => {
                const dayElement = document.createElement('div');
                let cardClass = 'forecast-day';
                let countClass = 'forecast-count';
                let labelClass = 'forecast-label';
                let dateClass = 'forecast-date';
                
                // Determine styling based on day
                if (day.day_offset === 0) {
                    cardClass += ' today';
                    countClass += ' today';
                    labelClass += ' today';
                    dateClass += ' today';
                } else if (day.day_offset === 1) {
                    cardClass += ' tomorrow';
                    countClass += ' tomorrow';
                    labelClass += ' tomorrow';
                    dateClass += ' tomorrow';
                } else {
                    cardClass += ' future';
                    countClass += ' future';
                    labelClass += ' future';
                    dateClass += ' future';
                }
                
                dayElement.className = cardClass;
                dayElement.innerHTML = `
                    <div class="${dateClass}">${day.date_label}</div>
                    <div class="${countClass}">${day.count}</div>
                    <div class="${labelClass}">${day.count === 1 ? 'Review' : 'Reviews'}</div>
                `;
                
                forecastGrid.appendChild(dayElement);
            });
        }

        function getConfidenceLevel(easeFactor) {
            if (easeFactor >= 2.0) return 'Very High';
            if (easeFactor >= 1.7) return 'High';
            if (easeFactor >= 1.4) return 'Medium';
            return 'Low';
        }

        function getConfidenceClass(easeFactor) {
            if (easeFactor >= 1.7) return 'confidence-high';
            if (easeFactor >= 1.4) return 'confidence-medium';
            return 'confidence-low';
        }

        async function showScheduleInfo(wordId) {
            try {
                const response = await fetch(`/api/sr/words/${wordId}/next-review`);
                const data = await response.json();
                
                if (response.ok) {
                    const confidence = getConfidenceLevel(data.ease_factor);
                    const confidenceClass = getConfidenceClass(data.ease_factor);
                    
                                         const message = `
📅 Review Schedule for "${data.word}"

⏰ Next Review: ${data.human_readable}
🎯 Confidence Level: ${confidence}
📊 Ease Factor: ${data.ease_factor}
🔄 Total Reviews: ${data.review_count}

💡 What this means:
• Again (0-2): Review in 4 hours (same day)
• Hard (3): Review in 1 day
• Good (4): Review in 6 days
• Easy (5): Review in 12+ days
• Higher confidence = longer intervals between reviews
• The system adapts to your learning pace
                     `;
                    
                    alert(message);
                } else {
                    alert('Failed to load schedule info: ' + data.error);
                }
            } catch (error) {
                console.error('Error loading schedule info:', error);
                alert('Error loading schedule info');
            }
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.trim();
            if (query) {
                searchWords(query);
            } else {
                loadVocabulary(); // Show all words if search is empty
            }
        });

        async function searchWords(query) {
            try {
                const response = await fetch(`/api/sr/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (response.ok) {
                    displayWords(data.words);
                }
            } catch (error) {
                console.error('Error searching words:', error);
            }
        }

        // Function to add all new words to vocabulary with enhanced translation comparison
        async function addNewWords() {
            if (newWords.length === 0) {
                alert('No new words to add!');
                return;
            }

            // Show loading state
            const addNewWordsBtn = document.getElementById('addNewWordsBtn');
            const originalText = addNewWordsBtn.innerHTML;
            addNewWordsBtn.innerHTML = '<span class="btn-text">🔄 Adding...</span><span class="word-count" id="newWordCount">(0)</span>';
            addNewWordsBtn.disabled = true;

            let addedCount = 0;
            let failedCount = 0;

            for (const wordObj of newWords) {
                try {
                    console.log(`🔄 Processing word: ${wordObj.word}`);
                    
                    // Get both AI and Google translations
                    const aiTranslation = await getAITranslation(wordObj.word);
                    const googleTranslation = await getGoogleTranslation(wordObj.word);
                    
                    let finalTranslation = aiTranslation; // Prefer AI translation
                    let translationSource = 'AI';
                    
                    // Compare translations if we have both
                    if (aiTranslation && googleTranslation && aiTranslation !== googleTranslation) {
                        console.log(`⚠️ Translation mismatch for "${wordObj.word}":`);
                        console.log(`  AI: "${aiTranslation}"`);
                        console.log(`  Google: "${googleTranslation}"`);
                        
                        // Prompt user to choose
                        const userChoice = await promptUserForTranslation(wordObj.word, aiTranslation, googleTranslation);
                        if (userChoice) {
                            finalTranslation = userChoice.translation;
                            translationSource = userChoice.source;
                        } else {
                            console.log(`⏭️ User skipped word: ${wordObj.word}`);
                            continue;
                        }
                    } else if (!aiTranslation && googleTranslation) {
                        finalTranslation = googleTranslation;
                        translationSource = 'Google Translate';
                    } else if (!aiTranslation && !googleTranslation) {
                        console.error(`❌ No translation available for: ${wordObj.word}`);
                        failedCount++;
                        continue;
                    }
                    
                    console.log(`✅ Using ${translationSource} translation: ${wordObj.word} -> ${finalTranslation}`);
                    
                    // Get word type and example from Google Translate (more reliable for this)
                    const wordData = await getWordData(wordObj.word);
                    
                    if (wordData) {
                        // Add word to vocabulary
                        const addResponse = await fetch('/api/sr/words', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                word: wordObj.word,
                                translation: finalTranslation,
                                example: wordData.example,
                                word_type: wordData.word_type,
                                notes: `Added from AI conversation (${translationSource})`
                            })
                        });

                        if (addResponse.ok) {
                            addedCount++;
                            console.log(`✅ Added word: ${wordObj.word}`);
                        } else {
                            failedCount++;
                            console.error(`❌ Failed to add word: ${wordObj.word}`);
                        }
                    } else {
                        failedCount++;
                        console.error(`❌ Failed to get word data for: ${wordObj.word}`);
                    }
                    
                } catch (error) {
                    failedCount++;
                    console.error(`💥 Error processing word ${wordObj.word}:`, error);
                }
            }

            // Show results
            if (addedCount > 0) {
                // Show success animation briefly before hiding
                addNewWordsBtn.classList.add('btn-success');
                setTimeout(() => {
                    addNewWordsBtn.classList.remove('btn-success');
                }, 600);
                
                alert(`Successfully added ${addedCount} new words to your vocabulary!${failedCount > 0 ? `\nFailed to add ${failedCount} words.` : ''}`);
                
                // Clear new words and hide buttons
                newWords = [];
                document.getElementById('addNewWordsBtn').style.display = 'none';
                document.getElementById('endConversationBtn').style.display = 'none';
                document.getElementById('newWordCount').textContent = '(0)';
                
                // Reload vocabulary to show new words
                await loadVocabulary();
                await loadCurrentVocabulary();
            } else {
                alert(`Failed to add any new words. Please try again.`);
            }
            
            // Restore button state
            addNewWordsBtn.disabled = false;
            addNewWordsBtn.innerHTML = originalText;
        }

        // Function to get Google Translate data (word type, example, etc.)
        async function getWordData(word) {
            try {
                const response = await fetch('/api/sr/ai-translate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ word: word })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        return {
                            translation: data.translation,
                            example: data.example,
                            word_type: data.word_type
                        };
                    }
                }
                return null;
            } catch (error) {
                console.error('💥 Error getting word data:', error);
                return null;
            }
        }

        // Function to get Google Translate only
        async function getGoogleTranslation(word) {
            try {
                const response = await fetch('/api/sr/ai-translate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ word: word })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        return data.translation;
                    }
                }
                return null;
            } catch (error) {
                console.error('💥 Error getting Google translation:', error);
                return null;
            }
        }

        // Function to prompt user for translation choice
        async function promptUserForTranslation(word, aiTranslation, googleTranslation) {
            return new Promise((resolve) => {
                const message = `Translation mismatch for "${word}":\n\n` +
                              `🤖 AI: "${aiTranslation}"\n` +
                              `🌐 Google: "${googleTranslation}"\n\n` +
                              `Which translation would you like to use?`;
                
                const choice = confirm(message + '\n\nClick OK for AI, Cancel for Google');
                
                if (choice) {
                    resolve({
                        translation: aiTranslation,
                        source: 'AI (User Choice)'
                    });
                } else {
                    resolve({
                        translation: googleTranslation,
                        source: 'Google Translate (User Choice)'
                    });
                }
            });
        }

        // Function to end conversation and add new words
        async function endConversation() {
            if (newWords.length === 0) {
                alert('No new words to add!');
                return;
            }
            
            const confirmed = confirm(`Add ${newWords.length} new words to your vocabulary?`);
            if (!confirmed) return;
            
            await addNewWords();
        }

        // Function to reset conversation
        function resetConversation() {
            newWords = [];
            document.getElementById('addNewWordsBtn').style.display = 'none';
            document.getElementById('endConversationBtn').style.display = 'none';
            document.getElementById('newWordCount').textContent = '(0)';
            
            // Hide loading indicator
            document.getElementById('aiThinking').style.display = 'none';
            
            // Clear chat messages
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            console.log('Conversation reset - new words cleared');
        }
    </script>
</body>
</html> 